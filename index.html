<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>NFT Ecosystem Metrics</title>
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite-api@5.6.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-tooltip"></script>
  </head>

  <body>
    <section class="container bubble">
      <div>
        <div id="nft_market_cap" class="metric"></div>
        <span>Total Market Cap</span>
      </div>
      <div>
        <div id="total_nfts" class="metric"></div>
        <span>Total NFTs</span>
      </div>
      <div>
        <div id="nft_holders" class="metric"></div>
        <span>Total NFT holders</span>
      </div>
    </section>
    <section class="container">
      <div class="row">
        <div class="column">
          <h2>Total NFT Sales Volume</h2>
          <div id="nft_sales_volume" class="metric"></div>
          <label class="switch">
            <input type="checkbox" />
            <span class="slider round"></span>
          </label>
        </div>
        <div class="column">
          <div
            id="nft_sales_volume"
            class="graph"
            data-spec="bar"
            data-title="NFT Sales Volume"
            data-style="light"
          ></div>
        </div>
      </div>
    </section>
    <section class="container dark">
      <h2>On-chain metrics</h2>
      <p>
        View the Hedera NFT ecosystem through the lens of on-chain metrics. Explore active
        accounts, NFT transfers, mints, and more.
      </p>
      <hr />
    </section>
    <div class="container dark">
      <section class="row">
        <div class="column">
          <h3>NFT Ecosystem Accounts</h3>
          <select>
            <option value="day">Day</option>
            <option value="week">Week</option>
            <option value="month" selected="selected">Month</option>
            <option value="quarter">Quarter</option>
            <option value="year">Year to Date</option>
            <option value="century">All time</option>
          </select>
          <h4>ACTIVE NFT ECOSYSTEM RETAIL ACCOUNTS ON HEDERA</h4>
          <p>
            Accounts that have performed at least one NFT-related retail transaction (NFT
            association, NFT transfer, received an NFT, per the specified period of time.
          </p>
        </div>
        <div class="column">
          <div
            id="accounts_associating_nfts"
            class="graph"
            data-spec="bar"
            data-title="Total accounts associating nfts"
          ></div>
        </div>
        <div
          id="accounts_sending_nfts"
          class="graph"
          data-spec="bar"
          data-title="Accounts that sent an nft"
        ></div>
        <div>
          <div
            id="accounts_receiving_nfts"
            class="graph"
            data-spec="bar"
            data-title="Accounts that received an nft"
          ></div>
          <div
            id="active_nft_accounts"
            class="graph"
            data-spec="bar"
            data-title="Total unique accounts that have performed 1 or more nft actions"
          ></div>
        </div>
      </section>
      <section class="row">
        <div class="column">
          <h4>Active NFT ecosystem builder accounts on Hedera</h4>
          <p>
            Accounts that have performed at least one NFT-related project/developer transaction
            (NFT collection creation, NFT mint), per the specified period of
          </p>
          <select>
            <option value="day">Day</option>
            <option value="week">Week</option>
            <option value="month" selected="selected">Month</option>
            <option value="quarter">Quarter</option>
            <option value="year">Year to Date</option>
            <option value="century">All time</option>
          </select>
        </div>
        <div class="column">
          <div
            id="accounts_creating_nft_collections"
            class="graph"
            data-spec="bar"
            data-title="Accounts creating nft collections"
          ></div>
          <div
            id="accounts_minting_nfts"
            class="graph"
            data-spec="bar"
            data-title="Accounts that minted an nft"
          ></div>
          <div
            id="active_nft_builder_accounts"
            class="graph"
            data-spec="bar"
            data-title="Accounts creating nft collections"
          ></div>
        </div>
      </section>
      <section class="row">
        <div class="column">
          <h3>NFT ecosystem activity</h3>
          <select>
            <option value="day">Day</option>
            <option value="week">Week</option>
            <option value="month" selected="selected">Month</option>
            <option value="quarter">Quarter</option>
            <option value="year">Year to Date</option>
            <option value="century">All time</option>
          </select>
          <p>Number of NFT collections created on Hedera, per the specified period of time.</p>
        </div>

        <div class="column">
          <div
            id="nft_collections_created"
            class="graph"
            data-spec="bar"
            data-title="New NFT collections on Hedera"
          ></div>
        </div>
      </section>
      <section class="row">
        <div class="column">
          <p>
            Number of NFTs minted into an existing NFT collection on Hedera, per the specified
            period of time.
          </p>
        </div>
        <div class="column">
          <div
            id="nfts_minted"
            class="graph"
            data-spec="line"
            data-title="NFTs minted Hedera"
          ></div>
          <div
            id="nfts_minted"
            class="graph"
            data-spec="line"
            data-title="Cumulative NFTs minted"
            data-options='{"cumulative": true}'
          ></div>
        </div>
      </section>
      <section class="row">
        <div class="column">
          <h2>NFT Ecosystem Account Cohort Analysis</h2>
          <p>
            Accounts in the Hedera NFT ecosystem that performed their first NFT
            ecosystem-related transaction and the percentage of accounts that returned to
            perform another related transaction in subsequent weeks.
          </p>
        </div>
        <!-- <div class="column"> -->
        <!--   <div id="todo" class="graph" data-spec="cohort"></div> -->
        <!-- </div> -->
        <iframe
          width="100%"
          height="684"
          frameborder="0"
          src="https://observablehq.com/embed/@hgraph/hedera-nft-ecosystem-cohort-analysis@2247?cells=viewof+selection"
        ></iframe>
      </section>
    </div>

    <script type="module">
      import * as app from './index.js'

      const data = await app.fetchData()

      // https://observablehq.com/@vega/vega-lite-api-v5#standalone_use
      // https://vega.github.io/vega-lite/docs/config.html
      const options = {
        config: {
          mark: {tooltip: null},
        },
        init: (view) => {
          view.tooltip(new vegaTooltip.Handler().call)
          if (view.container()) view.container().style['overflow-x'] = 'auto'
        },
        view: {
          renderer: 'canvas',
        },
      }

      // register vega and vega-lite with the API
      vl.register(vega, vegaLite, options)

      async function render(select) {
        /*
         * graphs
         */
        const siblings = select
          ? select.parentElement.parentElement.querySelectorAll('.graph')
          : document.querySelectorAll('.graph')
        for (const element of siblings) {
          const metric = element.id
          const period = select?.value || 'month'
          const title = element.getAttribute('data-title')?.toUpperCase()
          const spec = element.getAttribute('data-spec')
          const style = element.getAttribute('data-style') || 'dark'
          const options = JSON.parse(element.getAttribute('data-options') || '{}')
          const graph = await app[spec]({
            data: data.all_metrics.filter((d) => d.name === metric && d.period === period),
            period,
            title,
            style,
            ...options,
          })
          element.innerHTML = ''
          element.appendChild(graph)
        }
        /*
         * metrics
         */
        const metrics = document.querySelectorAll('.metric')
        for (const element of metrics) {
          const metric = element.id
          const value = data.all_metrics.find(
            (d) => d.name === metric && d.period === 'century'
          )
          element.innerHTML = value.total.toLocaleString()
        }
        setTimeout(() => window.dispatchEvent(new Event('resize')), 1)
      }

      // render when select menus change
      document.querySelectorAll('select').forEach((e) => {
        e.onchange = (e) => {
          render(e.target)
        }
      })

      // see if DOM is already available then render inital state
      if (document.readyState === 'complete' || document.readyState === 'interactive') {
        setTimeout(render, 1)
      } else {
        document.addEventListener('DOMContentLoaded', render)
      }
    </script>
  </body>
</html>
